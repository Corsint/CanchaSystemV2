<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis reservas</title>
  <style>
    h2 {
      margin-top: 20px;
    }
    li {
      margin-bottom: 10px;
    }
    .cancel-btn {
      background-color: crimson;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body style="font-family: sans-serif; padding: 20px;">
<h1>Mis reservas</h1>

<h2>ðŸŸ¡ Pendientes</h2>
<ul id="reservasPendientes"></ul>

<h2>ðŸ“‹ Finalizadas</h2>
<ul id="reservasFinalizadas"></ul>

<button onclick="window.location.href='/home-client.html'">Volver</button>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const pendientes = document.getElementById("reservasPendientes");
    const finalizadas = document.getElementById("reservasFinalizadas");

    pendientes.innerHTML = "<li>Cargando pendientes...</li>";
    finalizadas.innerHTML = "<li>Cargando...</li>";

    try {
      const res = await fetch("http://localhost:8080/reservation/findReservationsByClient");
      const reservas = await res.json();

      pendientes.innerHTML = "";
      finalizadas.innerHTML = "";

      if (reservas.length === 0) {
        pendientes.innerHTML = "<li>No hay reservas registradas.</li>";
        finalizadas.innerHTML = "";
        return;
      }

      reservas.forEach(r => {
        const li = document.createElement("li");

        li.innerHTML = `
          <strong>${r.cancha.name}</strong> - ${r.cancha.brand.brandName} <br>
          Fecha partido: ${r.matchDate} <br>
          DepÃ³sito: $${r.deposit} <br>
          Estado: ${r.status}
        `;

        if (r.status === "PENDING") {
          const btn = document.createElement("button");
          btn.textContent = "Cancelar";
          btn.className = "cancel-btn";
          btn.onclick = () => cancelarReserva(r.id);
          li.appendChild(document.createElement("br"));
          li.appendChild(btn);
          pendientes.appendChild(li);
        } else {
          finalizadas.appendChild(li);
        }
      });

      if (pendientes.innerHTML.trim() === "") {
        pendientes.innerHTML = "<li>No hay reservas pendientes.</li>";
      }
      if (finalizadas.innerHTML.trim() === "") {
        finalizadas.innerHTML = "<li>No hay reservas finalizadas o canceladas.</li>";
      }

    } catch (err) {
      pendientes.innerHTML = "<li>Error al cargar reservas.</li>";
      finalizadas.innerHTML = "";
      console.error(err);
    }
  });

  async function cancelarReserva(id) {
    if (!confirm("Â¿ConfirmÃ¡s cancelar esta reserva?")) return;

    try {
      const resActual = await fetch(`http://localhost:8080/reservation/${id}`);
      const reserva = await resActual.json();

      reserva.status = "CANCELED"; // el resto se mantiene tal como vino (matchDate en crudo)

      const res = await fetch("http://localhost:8080/reservation/update", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reserva)
      });

      if (res.ok) {
        alert("Reserva cancelada âœ…");
        location.reload();
      } else {
        alert("No se pudo cancelar.");
      }
    } catch (err) {
      console.error(err);
      alert("Error al cancelar la reserva.");
    }
  }
</script>
</body>
</html>
